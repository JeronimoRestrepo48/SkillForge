{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load core_extras %}

{% block title %}{{ curso.titulo|sin_certificacion }} - SkillForge{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'catalog:course_list' %}">Courses</a></li>
            <li class="breadcrumb-item active">{{ curso.titulo|sin_certificacion }}</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            {% if curso.imagen %}
            <img src="{{ curso.imagen.url }}" class="img-fluid rounded-3 mb-3 shadow-sm" alt="{{ curso.titulo|sin_certificacion }}" style="max-height: 380px; object-fit: cover; width: 100%;">
            {% else %}
            <img src="{{ curso|course_theme_image:'800x380' }}" class="img-fluid rounded-3 mb-3 shadow-sm" alt="{{ curso.titulo|sin_certificacion }}" style="max-height: 380px; object-fit: cover; width: 100%;">
            {% endif %}

            <h1 class="display-6 fw-bold mb-2">{{ curso.titulo|sin_certificacion }}</h1>
            <p class="text-muted mb-2">
                by {{ curso.instructor.get_full_name|default:curso.instructor.username }}
            </p>
            <div class="d-flex flex-wrap gap-2 mb-3">
                <span class="badge bg-secondary">{{ curso.get_nivel_dificultad_display }}</span>
                <span class="badge bg-info">{{ curso.categoria.nombre }}</span>
                <span class="badge bg-light text-dark">{{ curso.duracion_horas }} hours</span>
                {% if total_lecciones %}<span class="badge bg-light text-dark border">{{ total_lecciones }} lessons</span>{% endif %}
                {% if modulos %}<span class="badge bg-light text-dark border">{{ modulos|length }} modules</span>{% endif %}
                {% if rating_total > 0 %}
                <span class="badge bg-warning text-dark">
                    <i class="bi bi-star-fill"></i> {{ rating_promedio }} ({{ rating_total }} rating{{ rating_total|pluralize:"s" }})
                </span>
                {% endif %}
            </div>

            <!-- Instructor -->
            <div class="card mb-4 border-0 bg-light">
                <div class="card-body py-3">
                    <h6 class="text-uppercase text-muted small mb-2">Instructor</h6>
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center me-3" style="width: 48px; height: 48px; font-weight: bold;">{{ curso.instructor.get_full_name|default:curso.instructor.username|slice:":1" }}</div>
                        <div>
                            <strong>{{ curso.instructor.get_full_name|default:curso.instructor.username }}</strong>
                            <p class="mb-0 small text-muted">{{ curso.instructor.cursos_impartidos.count }} course{{ curso.instructor.cursos_impartidos.count|pluralize:"s" }} on SkillForge</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- What you'll learn (from first modules/lessons) -->
            {% if modulos %}
            <div class="mb-4">
                <h5 class="fw-bold mb-3">What you'll learn</h5>
                <ul class="list-unstyled">
                    {% for modulo in modulos %}
                    <li class="d-flex align-items-start mb-2">
                        <i class="bi bi-check2-circle text-success me-2 mt-1"></i>
                        <span>{{ modulo.titulo }}</span>
                    </li>
                    {% if modulo.lecciones.exists %}
                        {% for leccion in modulo.lecciones.all|slice:":2" %}
                        <li class="d-flex align-items-start mb-2 ms-4 small">
                            <i class="bi bi-circle-fill text-primary me-2" style="font-size: 0.4rem; margin-top: 0.5rem;"></i>
                            <span>{{ leccion.titulo }}</span>
                        </li>
                        {% endfor %}
                    {% endif %}
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Exámenes, trabajos y calificaciones -->
            {% if curso.info_evaluacion %}
            <div class="mb-4">
                <h5 class="fw-bold mb-3">Exámenes, trabajos y calificaciones</h5>
                <div class="small text-muted" style="white-space: pre-line;">{{ curso.info_evaluacion }}</div>
            </div>
            {% endif %}

            <!-- Requirements -->
            <div class="mb-4">
                <h5 class="fw-bold mb-3">Requirements</h5>
                <ul class="small text-muted">
                    <li>Basic computer skills</li>
                    <li>Internet connection</li>
                    <li>Desire to learn (level: {{ curso.get_nivel_dificultad_display }})</li>
                </ul>
            </div>

            <ul class="nav nav-tabs mb-3" id="cursoTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="desc-tab" data-bs-toggle="tab" data-bs-target="#desc" type="button" role="tab">Description</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="contenido-tab" data-bs-toggle="tab" data-bs-target="#contenido" type="button" role="tab">Curriculum</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="resenas-tab" data-bs-toggle="tab" data-bs-target="#resenas" type="button" role="tab">Reviews ({{ rating_total }})</button>
                </li>
            </ul>
            <div class="tab-content" id="cursoTabsContent">
                <div class="tab-pane fade show active" id="desc" role="tabpanel">
                    <h5>Description</h5>
                    <div class="curso-descripcion-larga" style="white-space: pre-line;">{{ curso.descripcion|sin_certificacion }}</div>
                </div>
                <div class="tab-pane fade" id="contenido" role="tabpanel">
                    <h5>Course content</h5>
                    {% if modulos %}
                    <ul class="list-group list-group-flush">
                        {% for modulo in modulos %}
                        <li class="list-group-item px-0">
                            <strong>Module {{ forloop.counter }}:</strong> {{ modulo.titulo }}
                            {% if modulo.duracion_minutos %}<span class="text-muted small">({{ modulo.duracion_minutos }} min)</span>{% endif %}
                            {% if modulo.lecciones.exists %}
                            <ul class="mt-2 mb-0">
                                {% for leccion in modulo.lecciones.all %}
                                <li class="small py-1">{{ leccion.titulo }} <span class="text-muted">({{ leccion.get_tipo_display }}{% if leccion.duracion_minutos %} · {{ leccion.duracion_minutos }} min{% endif %})</span></li>
                                {% endfor %}
                            </ul>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">This course has no published content yet.</p>
                    {% endif %}
                </div>
                <div class="tab-pane fade" id="resenas" role="tabpanel">
                    {% if calificacion_form %}
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="card-title">{% if mi_calificacion %}Edit your rating{% else %}Leave a rating{% endif %}</h5>
                            <p class="small text-muted">You can only rate courses you have completed.</p>
                            <form method="post" action="{% url 'catalog:course_rate' curso.pk %}">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="{{ request.path }}">
                                {{ calificacion_form|crispy }}
                                <button type="submit" class="btn btn-skillforge btn-sm">Save</button>
                            </form>
                        </div>
                    </div>
                    {% endif %}
                    {% if rating_total > 0 %}
                    <p class="mb-2"><strong>{{ rating_promedio }}</strong> <i class="bi bi-star-fill text-warning"></i> · {{ rating_total }} valoración{{ rating_total|pluralize:"es" }}</p>
                    <ul class="list-group list-group-flush">
                        {% for cal in calificaciones %}
                        <li class="list-group-item px-0">
                            <div class="d-flex justify-content-between">
                                <strong>{{ cal.user.get_full_name|default:cal.user.username }}</strong>
                                <span>{% if cal.es_verificada %}<span class="badge bg-success">Verified purchase</span>{% endif %}</span>
                            </div>
                            <p class="mb-0 small">
                                {% for i in "12345" %}{% if forloop.counter <= cal.puntuacion %}<i class="bi bi-star-fill text-warning"></i>{% else %}<i class="bi bi-star text-warning"></i>{% endif %}{% endfor %}
                                {{ cal.fecha_creacion|date:"d/m/Y" }}
                            </p>
                            {% if cal.comentario %}<p class="mt-1 mb-0">{{ cal.comentario }}</p>{% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">No reviews yet. Be the first to complete the course and leave a review!</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card card-cta shadow sticky-top">
                <div class="card-body">
                    <h4 class="text-primary">{{ precio_final }} COP</h4>
                    {% if curso.precio_descuento %}
                    <p class="text-muted text-decoration-line-through small">{{ curso.precio }} COP</p>
                    {% endif %}
                    {% if disponible %}
                    <p class="text-success small"><i class="bi bi-check-circle"></i> {{ curso.cupos_disponibles }} spots available</p>
                    {% if ya_inscrito %}
                    <a href="{% url 'catalog:course_learn' curso.pk %}" class="btn btn-skillforge w-100 mt-2">
                        <i class="bi bi-play-circle"></i> Go to course
                    </a>
                    {% elif user.is_authenticated %}
                    <form method="post" action="{% url 'transactions:cart_add' curso.pk %}" class="mt-2">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button type="submit" class="btn btn-skillforge w-100">
                            <i class="bi bi-cart-plus"></i> Add to cart
                        </button>
                    </form>
                    {% else %}
                    <a href="{% url 'core:login' %}?next={{ request.path }}" class="btn btn-skillforge w-100 mt-2">Log in to purchase</a>
                    {% endif %}
                    {% else %}
                    <p class="text-danger small">No spots available</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
